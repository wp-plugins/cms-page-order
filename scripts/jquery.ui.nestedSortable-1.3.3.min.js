(function(a){a.widget("ui.nestedSortable",a.extend({},a.ui.sortable.prototype,{options:{tabSize:20,disableNesting:"ui-nestedSortable-no-nesting",errorClass:"ui-nestedSortable-error",listType:"ol",maxLevels:0,noJumpFix:0},_create:function(){if(this.noJumpFix==false){this.element.height(this.element.height())}this.element.data("sortable",this.element.data("nestedSortable"));return a.ui.sortable.prototype._create.apply(this,arguments)},_mouseDrag:function(d){this.position=this._generatePosition(d);this.positionAbs=this._convertPositionTo("absolute");if(!this.lastPositionAbs){this.lastPositionAbs=this.positionAbs}if(this.options.scroll){var f=this.options,e=false;if(this.scrollParent[0]!=document&&this.scrollParent[0].tagName!="HTML"){if((this.overflowOffset.top+this.scrollParent[0].offsetHeight)-d.pageY<f.scrollSensitivity){this.scrollParent[0].scrollTop=e=this.scrollParent[0].scrollTop+f.scrollSpeed}else{if(d.pageY-this.overflowOffset.top<f.scrollSensitivity){this.scrollParent[0].scrollTop=e=this.scrollParent[0].scrollTop-f.scrollSpeed}}if((this.overflowOffset.left+this.scrollParent[0].offsetWidth)-d.pageX<f.scrollSensitivity){this.scrollParent[0].scrollLeft=e=this.scrollParent[0].scrollLeft+f.scrollSpeed}else{if(d.pageX-this.overflowOffset.left<f.scrollSensitivity){this.scrollParent[0].scrollLeft=e=this.scrollParent[0].scrollLeft-f.scrollSpeed}}}else{if(d.pageY-a(document).scrollTop()<f.scrollSensitivity){e=a(document).scrollTop(a(document).scrollTop()-f.scrollSpeed)}else{if(a(window).height()-(d.pageY-a(document).scrollTop())<f.scrollSensitivity){e=a(document).scrollTop(a(document).scrollTop()+f.scrollSpeed)}}if(d.pageX-a(document).scrollLeft()<f.scrollSensitivity){e=a(document).scrollLeft(a(document).scrollLeft()-f.scrollSpeed)}else{if(a(window).width()-(d.pageX-a(document).scrollLeft())<f.scrollSensitivity){e=a(document).scrollLeft(a(document).scrollLeft()+f.scrollSpeed)}}}if(e!==false&&a.ui.ddmanager&&!f.dropBehaviour){a.ui.ddmanager.prepareOffsets(this,d)}}this.positionAbs=this._convertPositionTo("absolute");if(!this.options.axis||this.options.axis!="y"){this.helper[0].style.left=this.position.left+"px"}if(!this.options.axis||this.options.axis!="x"){this.helper[0].style.top=this.position.top+"px"}for(var l=this.items.length-1;l>=0;l--){var m=this.items[l],g=m.item[0],c=this._intersectsWithPointer(m);if(!c){continue}if(g!=this.currentItem[0]&&this.placeholder[c==1?"next":"prev"]()[0]!=g&&!a.contains(this.placeholder[0],g)&&(this.options.type=="semi-dynamic"?!a.contains(this.element[0],g):true)){this.direction=c==1?"down":"up";if(this.options.tolerance=="pointer"||this._intersectsWithSides(m)){this._rearrange(d,m)}else{break}this._clearEmpty(g);this._trigger("change",d,this._uiHash());break}}var h=(this.placeholder[0].parentNode.parentNode&&a(this.placeholder[0].parentNode.parentNode).closest(".ui-sortable").length)?a(this.placeholder[0].parentNode.parentNode):null;var b=this._getLevel(this.placeholder);var j=this._getChildLevels(this.helper);var k=this.placeholder[0].previousSibling?a(this.placeholder[0].previousSibling):null;if(k!=null){while(k[0].nodeName.toLowerCase()!="li"||k[0]==this.currentItem[0]){if(k[0].previousSibling){k=a(k[0].previousSibling)}else{k=null;break}}}newList=document.createElement(f.listType);this.beyondMaxLevels=0;if(h!=null&&this.positionAbs.left<h.offset().left){h.after(this.placeholder[0]);this._clearEmpty(h[0]);this._trigger("change",d,this._uiHash())}else{if(k!=null&&this.positionAbs.left>k.offset().left+f.tabSize){this._isAllowed(k,b+j+1);if(k[0].children[1]==null){k[0].appendChild(newList)}k[0].children[1].appendChild(this.placeholder[0]);this._trigger("change",d,this._uiHash())}else{this._isAllowed(h,b+j)}}this._contactContainers(d);if(a.ui.ddmanager){a.ui.ddmanager.drag(this,d)}this._trigger("sort",d,this._uiHash());this.lastPositionAbs=this.positionAbs;return false},_mouseStop:function(d,e){if(this.beyondMaxLevels){var c=this.placeholder[0].parentNode.parentNode;for(var b=this.beyondMaxLevels-1;b>0;b--){c=c.parentNode.parentNode}this.placeholder.removeClass(this.options.errorClass);a(c).after(this.placeholder[0]);this._trigger("change",d,this._uiHash())}a.ui.sortable.prototype._mouseStop.apply(this,arguments)},serialize:function(d){var b=this._getItemsAsjQuery(d&&d.connected);var c=[];d=d||{};a(b).each(function(){var f=(a(d.item||this).attr(d.attribute||"id")||"").match(d.expression||(/(.+)[-=_](.+)/));var e=(a(d.item||this).parent(d.listType).parent("li").attr(d.attribute||"id")||"").match(d.expression||(/(.+)[-=_](.+)/));if(f){c.push((d.key||f[1]+"["+(d.key&&d.expression?f[1]:f[2])+"]")+"="+(e?(d.key&&d.expression?e[1]:e[2]):"root"))}});if(!c.length&&d.key){c.push(d.key+"=")}return c.join("&")},toHierarchy:function(e){e=e||{};var c=e.startDepthCount||0;var d=[];a(this.element).children("li").each(function(){var f=b(a(this));d.push(f)});return d;function b(f){var h=(a(f).attr(e.attribute||"id")||"").match(e.expression||(/(.+)[-=_](.+)/));if(h!=null){var g={id:h[2]};if(a(f).children(e.listType).children("li").length>0){g.children=[];a(f).children(e.listType).children("li").each(function(){var i=b(a(this));g.children.push(i)})}return g}}},toArray:function(g){g=g||{};var b=g.startDepthCount||0;var c=[];var e=2;c.push({item_id:"root",parent_id:"none",depth:b,left:"1",right:(a("li",this.element).length+1)*2});a(this.element).children("li").each(function(){e=f(this,b+1,e)});function d(i,h){return i.left-h.left}c=c.sort(d);return c;function f(h,j,i){right=i+1;if(a(h).children(g.listType).children("li").length>0){j++;a(h).children(g.listType).children("li").each(function(){right=f(a(this),j,right)});j--}id=(a(h).attr(g.attribute||"id")).match(g.expression||(/(.+)[-=_](.+)/));if(j===b+1){pid="root"}else{parentItem=(a(h).parent(g.listType).parent("li").attr("id")).match(g.expression||(/(.+)[-=_](.+)/));pid=parentItem[2]}if(id!=null){c.push({item_id:id[2],parent_id:pid,depth:j,left:i,right:right})}return i=right+1}},_clear:function(d,e){a.ui.sortable.prototype._clear.apply(this,arguments);for(var b=this.items.length-1;b>=0;b--){var c=this.items[b].item[0];this._clearEmpty(c)}return true},_clearEmpty:function(b){if(b.children[1]&&b.children[1].children.length==0){b.removeChild(b.children[1])}},_getLevel:function(b){var d=1;if(this.options.listType){var c=b.closest(this.options.listType);while(!c.is(".ui-sortable")){d++;c=c.parent().closest(this.options.listType)}}return d},_getChildLevels:function(b){levels=b.find(this.options.items).filter(this.options.items+":first-child").length;return levels},_isAllowed:function(b,c){var d=this.options;if(b==null||!(b.hasClass(d.disableNesting))){if(d.maxLevels<c&&d.maxLevels!=0){this.placeholder.addClass(d.errorClass);this.beyondMaxLevels=c-d.maxLevels}else{this.placeholder.removeClass(d.errorClass);this.beyondMaxLevels=0}}else{this.placeholder.addClass(d.errorClass);this.beyondMaxLevels=(c-d.maxLevels)>0?c-d.maxLevels:1}}}));a.ui.nestedSortable.prototype.options=a.extend({},a.ui.sortable.prototype.options,a.ui.nestedSortable.prototype.options)})(jQuery);